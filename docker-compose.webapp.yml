# ============================================
#  Web App Only - Connects to Existing Database
#  Use this when you already have PostgreSQL running
# ============================================
#
# Usage:
#   docker-compose -f docker-compose.webapp.yml up -d --build
#
# Prerequisites:
#   - PostgreSQL container "softpower_db" must be running
#   - Database must already have schema and data
#   - Network "softpower_net" must exist

name: softpower_webapp

services:
  # -----------------------
  # Web App (React + FastAPI)
  # Connects to existing PostgreSQL
  # -----------------------
  api:
    image: softpower-production:latest
    build:
      context: .
      dockerfile: docker/api-production.Dockerfile
      args:
        - NODE_ENV=production
    container_name: api-webapp
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DOCKER_ENV: "true"
      NODE_ENV: "production"
      # Connect to existing PostgreSQL container
      DB_HOST: softpower_db
      DB_PORT: 5432
      POSTGRES_HOST: softpower_db
      POSTGRES_PORT: 5432
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER:-matthew50}:${POSTGRES_PASSWORD:-softpower}@softpower_db:5432/${POSTGRES_DB:-softpower-db}
      # Optional S3 configuration
      S3_PROXY_URL: http://host.docker.internal:5001
      FASTAPI_URL: http://host.docker.internal:5001/material_query
      API_URL: http://host.docker.internal:5001
      USE_S3_API_CLIENT: "true"
    ports:
      - "8000:8000"
    volumes:
      # Optional: Mount config for runtime updates
      - ./shared/config/config.yaml:/app/shared/config/config.yaml:ro
      # Optional: Mount data directories
      - ./_data:/app/_data
    networks:
      - softpower_net
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # -----------------------
  # Streamlit Dashboard (Optional)
  # -----------------------
  dashboard:
    image: softpower_streamlit-dashboard:latest
    build:
      context: .
      dockerfile: docker/dashboard.Dockerfile
    container_name: streamlit-webapp
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DOCKER_ENV: "true"
      # Connect to existing PostgreSQL
      DB_HOST: softpower_db
      DB_PORT: 5432
      POSTGRES_HOST: softpower_db
      POSTGRES_PORT: 5432
      DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER:-matthew50}:${POSTGRES_PASSWORD:-softpower}@softpower_db:5432/${POSTGRES_DB:-softpower-db}
      # Connect to API service
      BACKEND_API_URL: http://api:8000
      API_URL: http://api:8000
      FASTAPI_URL: http://api:8000/material_query
    ports:
      - "8501:8501"
    volumes:
      - ./services/dashboard:/app/services/dashboard:ro
      - ./shared:/app/shared:ro
    networks:
      - softpower_net
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8501/_stcore/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - dashboard  # Optional, only start with --profile dashboard

# -----------------------
# Use Existing Network
# -----------------------
networks:
  softpower_net:
    external: true
    name: softpower_net
