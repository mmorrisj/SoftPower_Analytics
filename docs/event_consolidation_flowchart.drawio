<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="Claude" version="22.0.0">
  <diagram name="Event Consolidation Pipeline" id="event-consolidation-flow">
    <mxGraphModel dx="2200" dy="1800" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="2400" pageHeight="2400" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Title -->
        <mxCell id="title" value="Event Consolidation Pipeline: From Raw Events to Multi-Month Master Events" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=24;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="600" y="20" width="800" height="40" as="geometry" />
        </mxCell>
        <mxCell id="subtitle" value="How events are matched, consolidated, and tracked across time" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=14;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="600" y="55" width="800" height="25" as="geometry" />
        </mxCell>

        <!-- ==================== INPUT: RAW EVENTS ==================== -->
        <mxCell id="input-box" value="INPUT: RAW EVENTS" style="swimlane;fontStyle=1;startSize=30;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="100" width="350" height="200" as="geometry" />
        </mxCell>
        <mxCell id="input-tables" value="Source Tables:&#xa;• raw_events (doc_id, event_name)&#xa;• documents (doc_id, date, initiating_country)&#xa;• initiating_countries (doc_id, country)&#xa;• recipient_countries (doc_id, country)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="60" y="140" width="310" height="80" as="geometry" />
        </mxCell>
        <mxCell id="input-example" value="Example: 500 raw event names for China on 2024-08-15&#xa;Each linked to source documents with metadata" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontSize=10;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="60" y="230" width="310" height="50" as="geometry" />
        </mxCell>

        <!-- ==================== STAGE 1A: DBSCAN CLUSTERING ==================== -->
        <mxCell id="stage1a-box" value="STAGE 1A: DAILY DBSCAN CLUSTERING" style="swimlane;fontStyle=1;startSize=30;fillColor=#d5e8d4;strokeColor=#82b366;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="440" y="100" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="stage1a-script" value="Script: batch_cluster_events.py" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="450" y="135" width="200" height="15" as="geometry" />
        </mxCell>
        <mxCell id="stage1a-scope" value="Scope: Single country + Single day" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="460" y="155" width="360" height="25" as="geometry" />
        </mxCell>
        <mxCell id="stage1a-process" value="Process:&#xa;1. Load all raw_events for (country, date)&#xa;2. Generate embeddings (all-MiniLM-L6-v2)&#xa;3. Normalize names (lowercase, remove punctuation)&#xa;4. Apply DBSCAN clustering&#xa;5. Store clusters in event_clusters table" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="460" y="190" width="360" height="100" as="geometry" />
        </mxCell>
        <mxCell id="stage1a-params" value="DBSCAN Parameters:&#xa;• Metric: Cosine distance&#xa;• eps: Varies by country (typically 0.15-0.35)&#xa;  - 0.15 = Very tight (high precision)&#xa;  - 0.25 = Moderate&#xa;  - 0.35 = Loose (high recall)&#xa;• min_samples: 1 (allows singletons)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;fontSize=10;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="460" y="300" width="360" height="100" as="geometry" />
        </mxCell>
        <mxCell id="stage1a-output" value="Output: event_clusters table&#xa;(cluster_id, event_names[], doc_ids[], centroid_embedding)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="460" y="380" width="360" height="35" as="geometry" />
        </mxCell>

        <!-- Matching Criteria 1A -->
        <mxCell id="match1a" value="MATCHING CRITERIA" style="swimlane;fontStyle=1;startSize=20;fillColor=#e1d5e7;strokeColor=#9673a6;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="890" y="100" width="250" height="120" as="geometry" />
        </mxCell>
        <mxCell id="match1a-content" value="Same Cluster If:&#xa;&#xa;cosine_similarity(event_i, event_j) ≥ 0.85&#xa;&#xa;Question: &quot;Are these event names&#xa;semantically similar?&quot;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="900" y="125" width="230" height="85" as="geometry" />
        </mxCell>

        <!-- ==================== STAGE 1B: LLM DECONFLICTION ==================== -->
        <mxCell id="stage1b-box" value="STAGE 1B: LLM CLUSTER VALIDATION" style="swimlane;fontStyle=1;startSize=30;fillColor=#ffe6cc;strokeColor=#d79b00;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="460" width="400" height="380" as="geometry" />
        </mxCell>
        <mxCell id="stage1b-script" value="Script: llm_deconflict_clusters.py&#xa;Model: gpt-4o-mini (primary), gpt-4o (fallback)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="50" y="495" width="350" height="30" as="geometry" />
        </mxCell>
        <mxCell id="stage1b-scope" value="Scope: Within each DBSCAN cluster" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="60" y="515" width="360" height="25" as="geometry" />
        </mxCell>
        <mxCell id="stage1b-process" value="LLM Prompt:&#xa;&quot;Do these event names refer to the SAME&#xa;underlying real-world event?&quot;&#xa;&#xa;LLM Guidelines:&#xa;✅ Group if same event at different stages:&#xa;   &quot;Summit Announced&quot; ≈ &quot;Summit Begins&quot; ≈ &quot;Summit Concludes&quot;&#xa;❌ Split if different events:&#xa;   &quot;First Forum&quot; vs &quot;Second Forum&quot;&#xa;   &quot;Trade deal&quot; vs &quot;Defense pact&quot;&#xa;   &quot;China-Egypt&quot; vs &quot;China-UAE&quot;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="60" y="550" width="360" height="150" as="geometry" />
        </mxCell>
        <mxCell id="stage1b-output" value="LLM Response:&#xa;{&#xa;  &quot;same_event&quot;: true/false,&#xa;  &quot;groups&quot;: [[1,2,3], [4,5]],&#xa;  &quot;confidence&quot;: 0.95&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;fontSize=9;fontFamily=Courier New;align=left;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="60" y="710" width="360" height="80" as="geometry" />
        </mxCell>
        <mxCell id="stage1b-creates" value="Creates: canonical_events + daily_event_mentions" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="60" y="800" width="360" height="25" as="geometry" />
        </mxCell>

        <!-- Matching Criteria 1B -->
        <mxCell id="match1b" value="MATCHING CRITERIA" style="swimlane;fontStyle=1;startSize=20;fillColor=#e1d5e7;strokeColor=#9673a6;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="490" y="460" width="250" height="140" as="geometry" />
        </mxCell>
        <mxCell id="match1b-content" value="Same Event If:&#xa;&#xa;LLM determines names refer to same&#xa;real-world event across lifecycle:&#xa;• Announcement → Preparation&#xa;• Execution → Aftermath&#xa;&#xa;Question: &quot;Do these represent ONE&#xa;event at different stages?&quot;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="500" y="485" width="230" height="105" as="geometry" />
        </mxCell>

        <!-- ==================== CANONICAL EVENTS TABLE ==================== -->
        <mxCell id="canonical-box" value="canonical_events TABLE (112,510 total events)" style="swimlane;fontStyle=1;startSize=25;fillColor=#fff2cc;strokeColor=#d6b656;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="490" y="620" width="350" height="220" as="geometry" />
        </mxCell>
        <mxCell id="canonical-schema" value="id: UUID (primary key)&#xa;master_event_id: UUID (NULL = master, FK = child)&#xa;canonical_name: TEXT&#xa;initiating_country: TEXT&#xa;first_mention_date: DATE&#xa;last_mention_date: DATE&#xa;total_mention_days: INTEGER&#xa;total_articles: INTEGER&#xa;embedding_vector: FLOAT[]&#xa;alternative_names: TEXT[]&#xa;primary_categories: JSONB&#xa;primary_recipients: JSONB&#xa;material_score: NUMERIC(3,1)&#xa;material_justification: TEXT" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;fontFamily=Courier New;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="500" y="650" width="330" height="180" as="geometry" />
        </mxCell>

        <!-- ==================== DAILY MENTIONS TABLE ==================== -->
        <mxCell id="mentions-box" value="daily_event_mentions TABLE (140,037 mentions)" style="swimlane;fontStyle=1;startSize=25;fillColor=#fff2cc;strokeColor=#d6b656;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="890" y="460" width="300" height="180" as="geometry" />
        </mxCell>
        <mxCell id="mentions-schema" value="id: UUID&#xa;canonical_event_id: UUID (FK)&#xa;initiating_country: TEXT&#xa;mention_date: DATE&#xa;article_count: INTEGER&#xa;consolidated_headline: TEXT&#xa;doc_ids: TEXT[]&#xa;mention_context: TEXT&#xa;source_names: TEXT[]&#xa;&#xa;UNIQUE(canonical_event_id, mention_date)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;fontFamily=Courier New;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="900" y="490" width="260" height="140" as="geometry" />
        </mxCell>

        <!-- ==================== STAGE 2A: EMBEDDING CONSOLIDATION ==================== -->
        <mxCell id="stage2a-box" value="STAGE 2A: CROSS-DATE EMBEDDING CONSOLIDATION" style="swimlane;fontStyle=1;startSize=30;fillColor=#dae8fc;strokeColor=#6c8ebf;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="900" width="400" height="320" as="geometry" />
        </mxCell>
        <mxCell id="stage2a-script" value="Script: consolidate_all_events.py" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="50" y="935" width="200" height="15" as="geometry" />
        </mxCell>
        <mxCell id="stage2a-scope" value="Scope: ALL canonical_events for country (no date filter)" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="60" y="955" width="360" height="25" as="geometry" />
        </mxCell>
        <mxCell id="stage2a-process" value="Process:&#xa;1. Load ALL canonical_events where master_event_id IS NULL&#xa;2. Compute pairwise cosine similarity on embeddings&#xa;3. Find connected components (DFS) at threshold&#xa;4. For each group:&#xa;   • Pick MASTER = highest (articles, days_mentioned)&#xa;   • Set children: master_event_id → master.id&#xa;   • Master remains: master_event_id = NULL" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="60" y="990" width="360" height="130" as="geometry" />
        </mxCell>
        <mxCell id="stage2a-params" value="Similarity Threshold: 0.85 (default)&#xa;• 0.90+ = Very tight (exact variants)&#xa;• 0.85-0.89 = Good match (same event)&#xa;• 0.80-0.84 = Loose (needs LLM check)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="60" y="1130" width="360" height="70" as="geometry" />
        </mxCell>

        <!-- Matching Criteria 2A -->
        <mxCell id="match2a" value="MATCHING CRITERIA" style="swimlane;fontStyle=1;startSize=20;fillColor=#e1d5e7;strokeColor=#9673a6;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="490" y="900" width="350" height="140" as="geometry" />
        </mxCell>
        <mxCell id="match2a-content" value="Same Event Across Dates If:&#xa;&#xa;cosine_similarity(event_A.embedding, event_B.embedding) ≥ 0.85&#xa;&#xa;Transitive: If A~B and B~C, then A, B, C are grouped&#xa;&#xa;Question: &quot;Are events from different days actually&#xa;the same recurring real-world event?&quot;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="500" y="925" width="330" height="105" as="geometry" />
        </mxCell>

        <!-- ==================== HIERARCHY VISUALIZATION ==================== -->
        <mxCell id="hierarchy-box" value="MASTER_EVENT_ID HIERARCHY" style="swimlane;fontStyle=1;startSize=25;fillColor=#f8cecc;strokeColor=#b85450;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="890" y="700" width="350" height="260" as="geometry" />
        </mxCell>
        <mxCell id="hierarchy-before" value="BEFORE Consolidation (Stage 1B output):&#xa;&#xa;uuid-1: &quot;Belt and Road Summit&quot;, master_event_id: NULL, day: Aug 1&#xa;uuid-2: &quot;Belt and Road Summit&quot;, master_event_id: NULL, day: Aug 5&#xa;uuid-3: &quot;BRI Forum&quot;, master_event_id: NULL, day: Aug 10&#xa;(3 separate canonical events)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;align=left;spacingLeft=10;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="905" y="735" width="320" height="90" as="geometry" />
        </mxCell>
        <mxCell id="hierarchy-after" value="AFTER Consolidation (Stage 2A output):&#xa;&#xa;uuid-1: &quot;Belt and Road Summit&quot;, master_event_id: NULL ← MASTER&#xa;uuid-2: &quot;Belt and Road Summit&quot;, master_event_id: uuid-1 ← CHILD&#xa;uuid-3: &quot;BRI Forum&quot;, master_event_id: uuid-1 ← CHILD&#xa;(1 master with 2 children)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="905" y="835" width="320" height="90" as="geometry" />
        </mxCell>

        <!-- ==================== STAGE 2B: LLM VALIDATION ==================== -->
        <mxCell id="stage2b-box" value="STAGE 2B: LLM GROUP VALIDATION" style="swimlane;fontStyle=1;startSize=30;fillColor=#ffe6cc;strokeColor=#d79b00;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="490" y="1060" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="stage2b-script" value="Script: llm_deconflict_canonical_events.py&#xa;Model: gpt-4o-mini (primary), gpt-4o (fallback)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="500" y="1095" width="350" height="30" as="geometry" />
        </mxCell>
        <mxCell id="stage2b-scope" value="Scope: Groups linked by master_event_id" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="510" y="1115" width="360" height="25" as="geometry" />
        </mxCell>
        <mxCell id="stage2b-process" value="LLM Tasks:&#xa;1. Verify grouped events are truly the same event&#xa;2. Pick BEST canonical name (most recognizable)&#xa;3. Decide if group should be SPLIT&#xa;&#xa;LLM Response:&#xa;{&#xa;  &quot;same_event&quot;: true/false,&#xa;  &quot;best_canonical_name&quot;: &quot;Belt and Road Forum&quot;,&#xa;  &quot;should_split&quot;: true/false,&#xa;  &quot;split_groups&quot;: [{indices: [1,2], name: &quot;...&quot;}, ...]&#xa;}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;align=left;spacingLeft=10;fontSize=9;" vertex="1" parent="1">
          <mxGeometry x="510" y="1150" width="360" height="170" as="geometry" />
        </mxCell>

        <!-- Matching Criteria 2B -->
        <mxCell id="match2b" value="MATCHING CRITERIA" style="swimlane;fontStyle=1;startSize=20;fillColor=#e1d5e7;strokeColor=#9673a6;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="940" y="1060" width="300" height="140" as="geometry" />
        </mxCell>
        <mxCell id="match2b-content" value="Keep Together If:&#xa;• Same event, different phrasing&#xa;• Same event, different coverage levels&#xa;&#xa;Split If:&#xa;• Different instances (&quot;1st&quot; vs &quot;2nd&quot;)&#xa;• Different topics (Trade vs Defense)&#xa;• Different country pairs" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=5;" vertex="1" parent="1">
          <mxGeometry x="950" y="1085" width="280" height="105" as="geometry" />
        </mxCell>

        <!-- ==================== STAGE 2C: MERGE ==================== -->
        <mxCell id="stage2c-box" value="STAGE 2C: MULTI-DAY MERGE" style="swimlane;fontStyle=1;startSize=30;fillColor=#d5e8d4;strokeColor=#82b366;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="1280" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="stage2c-script" value="Script: merge_canonical_events.py" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;fontSize=11;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="50" y="1315" width="200" height="15" as="geometry" />
        </mxCell>
        <mxCell id="stage2c-scope" value="Scope: Master events + their children" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="60" y="1335" width="360" height="25" as="geometry" />
        </mxCell>
        <mxCell id="stage2c-process" value="Process:&#xa;1. For each MASTER event:&#xa;   • Find all CHILD events (master_event_id = master.id)&#xa;   • For each child:&#xa;     - Load all daily_event_mentions&#xa;     - Reassign mentions to master&#xa;     - Handle date conflicts (merge article counts)&#xa;     - Delete empty child event&#xa;&#xa;Date Conflict Resolution:&#xa;• If master has mention on same date: ADD counts&#xa;• If no conflict: UPDATE canonical_event_id" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;align=left;spacingLeft=10;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="60" y="1370" width="360" height="170" as="geometry" />
        </mxCell>

        <!-- ==================== FINAL OUTPUT ==================== -->
        <mxCell id="output-box" value="FINAL OUTPUT: CONSOLIDATED MASTER EVENTS" style="swimlane;fontStyle=1;startSize=30;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="490" y="1380" width="500" height="280" as="geometry" />
        </mxCell>
        <mxCell id="output-structure" value="Master Event Structure:&#xa;&#xa;canonical_events (master_event_id = NULL)&#xa;├── id: uuid-1&#xa;├── canonical_name: &quot;Belt and Road Initiative Forum&quot;&#xa;├── initiating_country: &quot;China&quot;&#xa;├── first_mention_date: 2024-08-01&#xa;├── last_mention_date: 2024-10-15&#xa;├── total_mention_days: 45&#xa;├── total_articles: 1,200&#xa;├── alternative_names: [&quot;BRI Forum&quot;, &quot;Belt Road Summit&quot;, ...]&#xa;├── material_score: 8.5&#xa;└── embedding_vector: [0.023, -0.156, ...]&#xa;&#xa;daily_event_mentions (linked to master)&#xa;├── 2024-08-01: 25 articles&#xa;├── 2024-08-02: 18 articles&#xa;├── 2024-08-15: 42 articles (peak)&#xa;├── 2024-09-03: 12 articles&#xa;└── 2024-10-15: 8 articles&#xa;&#xa;→ Full traceability: mention → doc_ids → source documents" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;align=left;spacingLeft=15;fontSize=10;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="510" y="1420" width="460" height="230" as="geometry" />
        </mxCell>

        <!-- ==================== TRACKING ACROSS TIME ==================== -->
        <mxCell id="tracking-box" value="HOW EVENTS ARE TRACKED ACROSS MONTHS" style="swimlane;fontStyle=1;startSize=25;fillColor=#f5f5f5;strokeColor=#666666;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1040" y="1240" width="350" height="320" as="geometry" />
        </mxCell>
        <mxCell id="tracking-fields" value="Key Tracking Fields:&#xa;&#xa;1. canonical_name&#xa;   → Unique identifier for the event&#xa;&#xa;2. master_event_id&#xa;   → NULL = this is the master&#xa;   → UUID = points to master (gets merged)&#xa;&#xa;3. first_mention_date / last_mention_date&#xa;   → Temporal span of event coverage&#xa;&#xa;4. total_mention_days&#xa;   → Days with at least 1 article&#xa;&#xa;5. embedding_vector&#xa;   → Semantic identity for matching&#xa;&#xa;6. daily_event_mentions[]&#xa;   → Per-day article counts &amp; doc_ids&#xa;   → Enables temporal trend analysis&#xa;&#xa;7. alternative_names[]&#xa;   → All name variants consolidated" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="1270" width="330" height="280" as="geometry" />
        </mxCell>

        <!-- ==================== ARROWS ==================== -->

        <!-- Input to Stage 1A -->
        <mxCell id="arrow1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="input-box" target="stage1a-box">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Stage 1A to Stage 1B -->
        <mxCell id="arrow2" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="stage1a-output" target="stage1b-box">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="640" y="440" />
              <mxPoint x="240" y="440" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Stage 1B to Canonical Events -->
        <mxCell id="arrow3" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1" source="stage1b-creates" target="canonical-box">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Stage 1B to Daily Mentions -->
        <mxCell id="arrow4" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1" source="stage1b-creates" target="mentions-box">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="450" y="815" />
              <mxPoint x="450" y="550" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Canonical to Stage 2A -->
        <mxCell id="arrow5" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#6c8ebf;" edge="1" parent="1" source="canonical-box" target="stage2a-box">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="665" y="860" />
              <mxPoint x="240" y="860" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Stage 2A to Hierarchy -->
        <mxCell id="arrow6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#6c8ebf;" edge="1" parent="1" source="stage2a-process" target="hierarchy-box">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="460" y="1055" />
              <mxPoint x="460" y="830" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Stage 2A to Stage 2B -->
        <mxCell id="arrow7" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#d79b00;" edge="1" parent="1" source="stage2a-box" target="stage2b-box">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>

        <!-- Stage 2B to Stage 2C -->
        <mxCell id="arrow8" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=2;strokeColor=#82b366;" edge="1" parent="1" source="stage2b-box" target="stage2c-box">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="690" y="1360" />
              <mxPoint x="240" y="1360" />
              <mxPoint x="240" y="1280" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- Stage 2C to Output -->
        <mxCell id="arrow9" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeWidth=3;strokeColor=#006EAF;" edge="1" parent="1" source="stage2c-box" target="output-box">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="240" y="1580" />
              <mxPoint x="240" y="1600" />
              <mxPoint x="480" y="1600" />
              <mxPoint x="480" y="1520" />
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- ==================== LEGEND ==================== -->
        <mxCell id="legend-box" value="LEGEND" style="swimlane;fontStyle=1;startSize=25;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1200" y="100" width="180" height="200" as="geometry" />
        </mxCell>
        <mxCell id="legend-dbscan" value="DBSCAN Stage" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="1220" y="135" width="100" height="25" as="geometry" />
        </mxCell>
        <mxCell id="legend-llm" value="LLM Stage" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="1220" y="170" width="100" height="25" as="geometry" />
        </mxCell>
        <mxCell id="legend-embed" value="Embedding Stage" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1220" y="205" width="100" height="25" as="geometry" />
        </mxCell>
        <mxCell id="legend-table" value="DB Table" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1220" y="240" width="100" height="25" as="geometry" />
        </mxCell>
        <mxCell id="legend-output" value="Final Output" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="1220" y="275" width="100" height="25" as="geometry" />
        </mxCell>

        <!-- ==================== THRESHOLDS BOX ==================== -->
        <mxCell id="thresholds-box" value="CONSOLIDATION THRESHOLDS" style="swimlane;fontStyle=1;startSize=25;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1200" y="320" width="180" height="180" as="geometry" />
        </mxCell>
        <mxCell id="thresholds-content" value="Stage 1A (DBSCAN):&#xa;  eps = 0.15&#xa;  similarity ≥ 0.85&#xa;&#xa;Stage 2A (Embedding):&#xa;  threshold = 0.85&#xa;&#xa;LLM Confidence:&#xa;  split if &lt; 0.80" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=10;fontColor=#ffffff;fontFamily=Courier New;" vertex="1" parent="1">
          <mxGeometry x="1210" y="350" width="160" height="140" as="geometry" />
        </mxCell>

        <!-- ==================== DATA INTEGRITY NOTE ==================== -->
        <mxCell id="integrity-box" value="DATA INTEGRITY STATUS" style="swimlane;fontStyle=1;startSize=25;fillColor=#f8cecc;strokeColor=#b85450;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1200" y="540" width="180" height="160" as="geometry" />
        </mxCell>
        <mxCell id="integrity-content" value="99.99% Complete&#xa;&#xa;Linkages:&#xa;140,029 / 140,037&#xa;mentions have doc_ids&#xa;&#xa;Missing: 8 events&#xa;• Iran: 6&#xa;• Turkey: 1&#xa;• Duplicates: 1&#xa;&#xa;Impact: 0.006%&#xa;(Negligible)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1210" y="570" width="160" height="120" as="geometry" />
        </mxCell>

        <!-- ==================== PROCESSING SCHEDULE ==================== -->
        <mxCell id="schedule-box" value="PROCESSING SCHEDULE" style="swimlane;fontStyle=1;startSize=25;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1200" y="730" width="180" height="200" as="geometry" />
        </mxCell>
        <mxCell id="schedule-content" value="Stage 1:&#xa;Daily Clustering&#xa;• Runs: Daily or&#xa;  on-demand per&#xa;  country&#xa;• Incremental&#xa;&#xa;Stage 2:&#xa;Batch Consolidation&#xa;• Runs: Periodically&#xa;  (weekly/monthly)&#xa;• Full dataset&#xa;• Updates master&#xa;  hierarchy" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=9;spacingLeft=10;fontColor=#ffffff;" vertex="1" parent="1">
          <mxGeometry x="1210" y="760" width="160" height="160" as="geometry" />
        </mxCell>

        <!-- ==================== EXAMPLE EVENT LIFECYCLE ==================== -->
        <mxCell id="example-box" value="EXAMPLE: EVENT TRACKED ACROSS 3 MONTHS" style="swimlane;fontStyle=1;startSize=25;fillColor=#e1d5e7;strokeColor=#9673a6;rounded=1;" vertex="1" parent="1">
          <mxGeometry x="1040" y="1580" width="350" height="220" as="geometry" />
        </mxCell>
        <mxCell id="example-content" value="Event: &quot;China-Arab States Cooperation Forum&quot;&#xa;&#xa;August 2024:&#xa;  • 15 mentions, 180 articles&#xa;  • &quot;Forum Announced&quot;, &quot;Preparations Begin&quot;&#xa;&#xa;September 2024:&#xa;  • 25 mentions, 450 articles (peak)&#xa;  • &quot;Forum Opens&quot;, &quot;Agreements Signed&quot;&#xa;&#xa;October 2024:&#xa;  • 8 mentions, 95 articles&#xa;  • &quot;Implementation Begins&quot;, &quot;Follow-up Meetings&quot;&#xa;&#xa;Total: 48 days tracked, 725 articles&#xa;Material Score: 7.8 (trade deals signed)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;spacingLeft=10;" vertex="1" parent="1">
          <mxGeometry x="1050" y="1610" width="330" height="180" as="geometry" />
        </mxCell>

        <!-- ==================== VERSION INFO ==================== -->
        <mxCell id="version-box" value="Diagram Version: 2.0 | Last Updated: 2025-12-19 | Status: High-priority fixes applied" style="text;html=1;strokeColor=#666666;fillColor=#f5f5f5;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=1;fontSize=9;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="40" y="1830" width="950" height="25" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
